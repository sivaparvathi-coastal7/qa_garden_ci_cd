name: QA Garden Pipeline
 
on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
 
jobs:
  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
 
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
 
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8 black
 
      - name: Run flake8
        run: flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
 
      - name: Auto-format with Black
        run: black . || true
 
  test:
    name: Run Playwright Tests
    needs: lint
    runs-on: ubuntu-latest
    timeout-minutes: 60
    env:
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

 
    steps:
      - uses: actions/checkout@v4
        with:
          repository: sivaparvathi-coastal7/qa_garden_ci_cd
 
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
 
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-playwright pytest-json-report requests groq
           
      - name: Install Playwright Browsers
        run: python -m playwright install  # install all browsers
 
      - name: Generate Test Script
        run: |
          if [ -f "generate_script.py" ]; then
            python3 generate_script.py || echo "‚ö†Ô∏è Test generation skipped"
          else
            echo "Skipping generation (script not found)"
          fi
       
      - name: Upload Generated Tests
        uses: actions/upload-artifact@v4
        with:
          name: generated-tests
          path: tests/
 
      - name: Run Tests
        id: pytest
        continue-on-error: true
        run: |
          pytest --verbose \
          --json-report \
          --json-report-file=test-report.json \
          --output=test-results \
          --screenshot=only-on-failure \
          --video=retain-on-failure

      - name: Debug Test Results
        run: |
          echo "=== TEST DEBUG ==="
          if [ -f "test-report.json" ]; then
          python -c "
          import json
          r = json.load(open('test-report.json'))
          print(f'Tests run: {len(r.get(\"tests\", []))}')
          print(f'Failed: {len([t for t in r.get(\"tests\", []) if t.get(\"outcome\") == \"failed\"])}')
          print(f'Passed: {len([t for t in r.get(\"tests\", []) if t.get(\"outcome\") == \"passed\"])}')
          "
          else
          echo "No test-report.json found"
          fi

      - name: Generate Failure JSON Immediately
        run: |
          python - <<'EOF'
          import json, os, sys 
          # ‚úÖ Fixed import
          # Force create failures if no test-report.json
          if not os.path.exists("test-report.json"):
              failures = [{
                  "test_name": "CI_ERROR",
                  "error_message": "No test report generated",
                  "file_path": "pytest",
                  "stack_trace": "Tests may not have executed properly",
                  "logs": "",
                  "labels": ["ci_error"]
              }]
              with open("failure_payload.json", "w") as f:
                  json.dump(failures, f, indent=2)
              sys.exit(0)
    
          # Process actual test results
          with open("test-report.json") as f:
               report = json.load(f)
    
          failures = []
          for test in report.get("tests", []):
              if test.get("outcome") in ("failed", "error"):
                  failures.append({
                      "test_name": test.get("nodeid", "unknown"),
                      "error_message": str(test.get("call", {}).get("longrepr", "")).split("\n")[0],
                      "file_path": test.get("nodeid", "").split("::")[0],
                      "stack_trace": str(test.get("call", {}).get("longrepr", "")),
                      "logs": test.get("stdout", "") + test.get("stderr", ""),
                      "labels": ["test_failure"]
                  })
    
          # ‚úÖ FORCE CREATE SAMPLE FAILURE IF ALL PASS (for debugging)
          if len(failures) == 0:
          failures = [{
             "test_name": "DEBUG_ALL_TESTS_PASSED",
             "error_message": f"All {len(report.get('tests', []))} tests passed in CI",
             "file_path": "debug",
             "stack_trace": f"Summary: {report.get('summary', {})}",
             "logs": "This indicates environment differences between local and CI",
             "labels": ["debug", "all_passed"]
           }]
    
           with open("failure_payload.json", "w") as f:
               json.dump(failures, f, indent=2)
    
           print(f"Generated {len(failures)} failure entries")
           EOF
 
      - name: Fail job if tests failed
        continue-on-error: true
        run: |
          python - <<'EOF'
          import json, sys
 
          with open("test-report.json") as f:
              report = json.load(f)
          has_runtime_failures = any(
              t.get("outcome") in ("failed", "error")
              for t in report.get("tests", [])
          )
 
          has_collection_errors = any(
              c.get("outcome") == "failed"
              for c in report.get("collectors", [])
          )
 
          if has_runtime_failures or has_collection_errors:
              print("‚ùå Test failures or collection errors detected")
              sys.exit(1)
          else:
              print("‚úÖ All tests passed")
          EOF
           
      - name: Checkout Triage Repo
        uses: actions/checkout@v4
        with:
          repository: Tulasiram01/QA-GARDEN
          token: ${{ secrets.TRIAGE_PAT }}
          path: triage-folder
          fetch-depth: 0
 
      - name: Push Reports to Triage Repo
        run: |
          cp failure_payload.json triage-folder/failure_payload_${{ github.run_id }}.json || true
 
          cd triage-folder
          git config user.name "QA Garden Bot"
          git config user.email "bot@github.com"
          git remote set-url origin https://x-access-token:${{ secrets.TRIAGE_PAT }}@github.com/Tulasiram01/QA-GARDEN.git
          git add .
          git commit -m "üö® Automated Defect: Run ${{ github.run_id }}" || echo "No changes to commit"
          git push origin main || echo "Push failed"
 
      - name: Upload Test Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: playwright-results
          path: |
            test-report.json
            failure_payload.json
            test-results/
          retention-days: 7
 
 
